importScripts("https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js");const API_KEY="https://new.larry-jacobo.com/api/email",STATIC_CACHE="static-v3",DYNAMIC_CACHE="dynamic-v1",INMUTABLE_CACHE="inmutable-v1";function actualizarCacheDinamico(t,e,n){return n.ok?caches.open(t).then((t=>(t.put(e,n.clone()),n.clone()))):n}function actualizarCacheEstatico(t,e,n){if(!n.includes(e.url))return fetch(e).then((n=>actualizarCacheDinamico(t,e,n)))}const db=new PouchDB("mensaje");function guardarMensaje(t){return t._id=(new Date).toISOString(),db.put(t).then((()=>{self.registration.sync.register("nuevo-post");return new Response(JSON.stringify({ok:!0,offline:!0}))}))}function manejoApiMensajes(t,e){return e.url.indexOf("/api/notification/key")>=0||e.url.indexOf("/api/notification/subscribe")||e.url.indexOf("/api/notification/push")>=0?fetch(e):"POST"===e.clone().method?self.registration.sync?e.clone().text().then((t=>{guardarMensaje(JSON.parse(t))})):fetch(e):fetch(e).then((n=>n.ok?(actualizarCacheDinamico(t,e,n.clone()),n.clone()):caches.match(e))).catch((t=>caches.match(e)))}const APP_SHELL=["/","index.html","assets/images/fondo1.jpg","assets/images/anthonyopt.jpg","assets/images/anthonyfavicon.png"],APP_SHELL_INMUTABLE=["https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js"];function postearMensajes(){const t=[];return db.allDocs({include_docs:!0}).then((e=>(e.rows.forEach((e=>{const n=e.doc,i=fetch(API_KEY,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",body:JSON.stringify(n)}).then((t=>db.remove(n)));t.push(i)})),Promise.all(t))))}self.addEventListener("install",(t=>{const e=caches.open("static-v3").then((t=>{t.addAll(APP_SHELL)}));t.waitUntil(Promise(e))})),self.addEventListener("activate",(t=>{const e=caches.keys().then((t=>{t.forEach((t=>{if("static-v3"!==t&&t.includes("static"))return caches.delete(t)}))}));t.waitUntil(e)})),self.addEventListener("fetch",(t=>{let e;t.request.url;if(t.request.url.includes("/api"))return manejoApiMensajes("dynamic-v1",t.request);e=caches.match(t.request).then((e=>e?(actualizarCacheEstatico("static-v3",t.request,APP_SHELL_INMUTABLE),e):fetch(t.request).then((e=>actualizarCacheDinamico("dynamic-v1",t.request,e))))),t.respondWith(e)})),self.addEventListener("sync",(t=>{if("nuevo-post"===t.tag){const e=postearMensajes();t.waitUntil(e)}})),self.addEventListener("push",(t=>{const e=JSON.parse(t.data.text()),n=e.titulo,i={body:e.cuerpo,icon:"./assets/images/anthonyopt.jpg",badge:"./assets/images/anthonyopt.jpg",vibrate:[250,200,150,150,100,50,450,450,150,150,100,50,900,2250],openUrl:"/",data:{url:"/",id:e.usuario},actions:[{action:"action 1",title:"Action 1",icon:"./assets/images/client1.jpg"},{action:"action 2",title:"Action 2",icon:"./assets/images/fondo1.jpg"}]};t.waitUntil(self.registration.showNotification(n,i))})),self.addEventListener("notificationclose",(t=>{})),self.addEventListener("notificationclick",(t=>{const e=t.notification,n=(t.action,clients.matchAll().then((t=>{let n=t.find((t=>"visible"===t.visibilityState));return void 0!==n?(n.navigate(e.data.url),n.focus()):clients.openWindow(e.data.url),e.close()})));t.waitUntil(n)}));