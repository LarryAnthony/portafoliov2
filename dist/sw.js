importScripts("https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js");const API_KEY="https://new.larry-jacobo.com/api/email",STATIC_CACHE="static-v7",DYNAMIC_CACHE="dynamic-v1",INMUTABLE_CACHE="inmutable-v1";function actualizarCacheDinamico(e,t,n){return n.ok?caches.open(e).then((e=>(e.put(t,n.clone()),n.clone()))):n}function actualizarCacheEstatico(e,t,n){if(!n.includes(t.url))return fetch(t).then((n=>actualizarCacheDinamico(e,t,n)))}const db=new PouchDB("mensaje");function guardarMensaje(e){return e._id=(new Date).toISOString(),db.put(e).then((()=>{self.registration.sync.register("nuevo-post");return new Response(JSON.stringify({ok:!0,offline:!0}))}))}function manejoApiMensajes(e,t){return t.url.indexOf("/api/notification/key")>=0||t.url.indexOf("/api/notification/subscribe")||t.url.indexOf("/api/notification/push")>=0?fetch(t):"POST"===t.clone().method?self.registration.sync?t.clone().text().then((e=>{guardarMensaje(JSON.parse(e))})):fetch(t):fetch(t).then((n=>n.ok?(actualizarCacheDinamico(e,t,n.clone()),n.clone()):caches.match(t))).catch((e=>caches.match(t)))}const APP_SHELL=["/","index.html","assets/images/fondo1.jpg","assets/images/anthonyopt.jpg","assets/images/anthonyfavicon.png","main.js","assets/main.css"],APP_SHELL_INMUTABLE=["https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js"];function postearMensajes(){const e=[];return db.allDocs({include_docs:!0}).then((t=>(t.rows.forEach((t=>{const n=t.doc,i=fetch(API_KEY,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",body:JSON.stringify(n)}).then((e=>db.remove(n)));e.push(i)})),Promise.all(e))))}self.addEventListener("install",(e=>{const t=caches.open("static-v7").then((e=>{e.addAll(APP_SHELL)})),n=caches.open("inmutable-v1").then((e=>{e.addAll(APP_SHELL_INMUTABLE)}));e.waitUntil(Promise([t,n]))})),self.addEventListener("activate",(e=>{console.log("Hi");const t=caches.keys().then((e=>{e.forEach((e=>"static-v7"!==e&&e.includes("static")||"dynamic-v1"!==e&&e.includes("dynamic")?caches.delete(e):void 0))}));e.waitUntil(t)})),self.addEventListener("fetch",(e=>{let t;e.request.url;t=e.request.url.includes("/api")?manejoApiMensajes("dynamic-v1",e.request):caches.match(e.request).then((t=>t?APP_SHELL.includes(t.url)?(actualizarCacheEstatico("static-v7",e.request,APP_SHELL_INMUTABLE),t):t:fetch(e.request).then((t=>actualizarCacheDinamico("dynamic-v1",e.request,t))))),e.respondWith(t)})),self.addEventListener("sync",(e=>{if("nuevo-post"===e.tag){const t=postearMensajes();e.waitUntil(t)}})),self.addEventListener("push",(e=>{const t=JSON.parse(e.data.text()),n=t.titulo,i={body:t.cuerpo,icon:"./assets/images/anthonyopt.jpg",badge:"./assets/images/anthonyopt.jpg",vibrate:[250,200,150,150,100,50,450,450,150,150,100,50,900,2250],openUrl:"/",data:{url:"/",id:t.usuario},actions:[{action:"action 1",title:"Action 1",icon:"./assets/images/client1.jpg"},{action:"action 2",title:"Action 2",icon:"./assets/images/fondo1.jpg"}]};e.waitUntil(self.registration.showNotification(n,i))})),self.addEventListener("notificationclose",(e=>{})),self.addEventListener("notificationclick",(e=>{const t=e.notification,n=(e.action,clients.matchAll().then((e=>{let n=e.find((e=>"visible"===e.visibilityState));return void 0!==n?(n.navigate(t.data.url),n.focus()):clients.openWindow(t.data.url),t.close()})));e.waitUntil(n)}));